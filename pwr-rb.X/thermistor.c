#include <xc.h>

#include <stdint.h>

#include "thermistor.h"
#include "util.h"

// LUT generated with https://docs.google.com/spreadsheets/d/1hJ4xm4ctOhD3xQJsMkJB0SFqOTj0b5eIRtts3pyHp-4/edit#gid=1756690520
// -20 to 127 degrees C
static const uint16_t thermistor_lut[] = {941,
936,
931,
926,
920,
914,
908,
902,
895,
889,
881,
874,
867,
859,
851,
842,
834,
825,
816,
806,
797,
787,
777,
767,
756,
746,
735,
724,
713,
701,
690,
678,
667,
655,
643,
631,
619,
607,
595,
583,
571,
559,
547,
535,
523,
512,
500,
488,
477,
465,
454,
443,
431,
421,
410,
399,
389,
379,
368,
359,
349,
339,
330,
321,
312,
303,
295,
286,
278,
262,
262,
255,
248,
240,
233,
227,
220,
213,
207,
201,
195,
189,
184,
178,
173,
168,
163,
158,
154,
149,
145,
140,
136,
132,
128,
125,
121,
117,
114,
111,
108,
104,
101,
98,
96,
93,
90,
88,
85,
83,
80,
78,
76,
74,
72,
70,
68,
66,
64,
62,
61,
59,
57,
56,
54,
53,
51,
50,
49,
48,
46,
45,
44,
43,
42,
40,
39,
38,
37,
37,
36,
35,
34,
33,
32,
31,
31,
30
};

int8_t thermistor_lookup(uint16_t code)
{
	if (code > (thermistor_lut[0] + 50)) {
		return INVALID_TEMP; // No thermistor connected
	}
	
	for (int i = 0; i < ARRAY_SIZE(thermistor_lut); i++) {
		if (thermistor_lut[i] < code) {
			return i - 20;
		}
	}
	return -128;
}
